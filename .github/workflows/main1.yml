name: CI–CD Build, Tag, Push & Deploy BE

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: "Select environment for deployment"
        required: true
        options:
          - dev
          - preprod

jobs:
  setup:
    name: Resolve Environment Variables
    runs-on: ubuntu-latest
    outputs:
      component: ${{ steps.vars.outputs.component }}
      repository: ${{ steps.vars.outputs.repository }}
      app_name: ${{ steps.vars.outputs.app_name }}
      resource_group: ${{ steps.vars.outputs.resource_group }}
      branch: ${{ steps.vars.outputs.branch }}
    steps:
      - id: vars
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "dev" ]]; then
            echo "component=aimib-app-dev" >> $GITHUB_OUTPUT
            echo "repository=aimib-dev" >> $GITHUB_OUTPUT
            echo "app_name=${{ vars.DEV_CONTAINER_APP_NAME }}" >> $GITHUB_OUTPUT
            echo "branch=release/dev" >> $GITHUB_OUTPUT
          else
            echo "component=aimib-app" >> $GITHUB_OUTPUT
            echo "repository=aimib" >> $GITHUB_OUTPUT
            echo "app_name=${{ vars.BE_CONTAINER_APP_NAME }}" >> $GITHUB_OUTPUT
            echo "branch=release/preprod" >> $GITHUB_OUTPUT
          fi
          # Common resource group
          echo "resource_group=${{ vars.RESOURCE_GROUP_NAME }}" >> $GITHUB_OUTPUT

  versioning:
    name: Version & Tag
    needs: setup
    permissions: { contents: write }
    runs-on: ubuntu-latest
    concurrency:
      group: ci-${{ github.ref_name }}
      cancel-in-progress: false
    outputs:
      git_tag: ${{ steps.version.outputs.next_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: ${{ needs.setup.outputs.branch }}

      - id: version
        run: |
          set -euo pipefail
          git fetch --tags --force
          LATEST=$(git tag -l "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n1 || true)
          FLOOR_MAJOR=1; FLOOR_MINOR=0; FLOOR_PATCH=0
          if [[ -z "$LATEST" ]]; then
            MA=$FLOOR_MAJOR; MI=$FLOOR_MINOR; PA=$FLOOR_PATCH
          else
            ver="${LATEST#v}"; IFS='.' read -r MA MI PA <<< "$ver"
            if (( MA < FLOOR_MAJOR )); then
              MA=$FLOOR_MAJOR; MI=$FLOOR_MINOR; PA=$FLOOR_PATCH
            else
              PA=$((PA+1))
            fi
          fi
          NEXT="v${MA}.${MI}.${PA}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$NEXT" -m "CI: reserve ${NEXT}"
          git push origin "$NEXT"
          echo "next_tag=$NEXT" >> "$GITHUB_OUTPUT"

      - run: |
          echo "Git tag: ${{ steps.version.outputs.next_tag }}" >> "$GITHUB_STEP_SUMMARY"

  build:
    name: Build Image Artifact • ${{ needs.setup.outputs.component }}
    needs: [versioning, setup]
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    env:
      ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
    strategy:
      matrix:
        include:
          - component: ${{ needs.setup.outputs.component }}
            context: ./agents/rag-agent
            dockerfile: ./agents/rag-agent/Dockerfile
            repository: ${{ needs.setup.outputs.repository }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup.outputs.branch }}
      - uses: docker/setup-buildx-action@v3

      - id: meta
        env:
          TAG: ${{ needs.versioning.outputs.git_tag }}
          REGISTRY: ${{ env.ACR_LOGIN_SERVER }}
          REPOSITORY: ${{ matrix.repository }}
          COMPONENT: ${{ matrix.component }}
        run: |
          image_tag="${TAG}-${COMPONENT}"
          image="${REGISTRY}/${REPOSITORY}:${image_tag}"
          echo "image_tag=${image_tag}" >> "$GITHUB_OUTPUT"
          echo "image=${image}" >> "$GITHUB_OUTPUT"

      - uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          tags: ${{ steps.meta.outputs.image }}
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - run: docker save ${{ steps.meta.outputs.image }} -o image-${{ matrix.component }}.tar

      - uses: actions/upload-artifact@v4
        with:
          name: image-${{ matrix.component }}
          path: image-${{ matrix.component }}.tar

  push:
    name: Push Image • ${{ needs.setup.outputs.component }}
    needs: [versioning, build, setup]
    runs-on: self-hosted
    outputs:
      image_ref: ${{ steps.ref.outputs.image_ref }} 
    environment: ${{ github.event.inputs.environment }}
    strategy:
      matrix:
        include:
          - component: ${{ needs.setup.outputs.component }}
            repository: ${{ needs.setup.outputs.repository }}
    env:
      TAG: ${{ needs.versioning.outputs.git_tag }}
      ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
      ACR_TOKEN_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_TOKEN_PASSWORD: ${{ secrets.ACR_PASSWORD }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: image-${{ matrix.component }}
          path: .

      - name: DNS sanity
        run: getent hosts "$ACR_LOGIN_SERVER" || true

      - id: ref
        env:
          COMPONENT: ${{ matrix.component }}
        run: |
          IMAGE_REF="${ACR_LOGIN_SERVER}/${{ matrix.repository }}:${TAG}-${COMPONENT}"
          echo "$IMAGE_REF" > image_ref.txt
          echo "image_ref=$IMAGE_REF" >> "$GITHUB_OUTPUT"

      - name: Push via Skopeo
        run: |
          set -euxo pipefail
          IMAGE_REF="${{ steps.ref.outputs.image_ref }}"
          skopeo copy --retry-times 3 \
            --dest-creds "${ACR_TOKEN_USERNAME}:${ACR_TOKEN_PASSWORD}" \
            docker-archive:image-${{ matrix.component }}.tar \
            docker://"$IMAGE_REF"

      - name: Upload image ref
        uses: actions/upload-artifact@v4
        with:
          name: image-ref-${{ matrix.component }}
          path: image_ref.txt

  deploy:
    name: Deploy Image • ${{ needs.setup.outputs.component }}
    needs: [versioning, build, push, setup]
    runs-on: self-hosted
    environment: preprod
    permissions:
      id-token: write 
      contents: read  
    strategy:
      matrix:
        include:
          - component: ${{ needs.setup.outputs.component }}
            container_app_name: ${{ needs.setup.outputs.app_name }}
            resource_group: ${{ needs.setup.outputs.resource_group }}
    env:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    steps:
      - name: CICD Bot token
        id: cicd-bot-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.CICD_BOT_APP_ID || '981379' }}
          private-key: ${{ secrets.CICD_BOT_APP_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Configure Bot
        run: |
          user_id=$(gh api "/users/${{ steps.cicd-bot-token.outputs.app-slug }}[bot]" --jq .id)
          git config --global user.name '${{ steps.cicd-bot-token.outputs.app-slug }}[bot]'
          git config --global user.email "$user_id+${{ steps.cicd-bot-token.outputs.app-slug }}[bot]@users.noreply.github.com"
          echo "GH_TOKEN=$GH_TOKEN" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ steps.cicd-bot-token.outputs.token }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.cicd-bot-token.outputs.token }}
          ref: ${{ needs.setup.outputs.branch }}

      - uses: actions/download-artifact@v4
        with:
          name: image-ref-${{ matrix.component }}
          path: .

      - name: Read image ref
        id: get-image
        run: |
          IMAGE_REF=$(cat image_ref.txt)
          echo "IMAGE_REF=$IMAGE_REF" >> $GITHUB_ENV
          echo "Using image: $IMAGE_REF"

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Container App
        run: |
          az containerapp update \
            --name ${{ matrix.container_app_name }} \
            --resource-group ${{ matrix.resource_group }} \
            --image $IMAGE_REF \
            --set configuration.ingress.targetPort=80 \
            --output tsv

      - name: Deployment Summary
        run: |
          APP_URL=$(az containerapp show \
              --name ${{ matrix.container_app_name }} \
              --resource-group ${{ matrix.resource_group }} \
              --query properties.configuration.ingress.fqdn -o tsv)
          echo "Deployment complete!"
          echo "App URL: https://$APP_URL"
